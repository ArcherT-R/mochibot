<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mochi Bar Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>Mochi Bar</h1>
    <div class="search-container">
      <input type="text" id="searchBar" placeholder="Search players...">
      <div id="searchResults"></div>
    </div>
  </header>

  <main>
    <!-- Top 3 Most Active -->
    <section>
      <h2>Top 3 Most Active</h2>
      <ul>
        <% if (topPlayers && topPlayers.length > 0) { %>
          <% topPlayers.forEach(p => { %>
            <li>
              <a href="/dashboard/player/<%= p.username %>"><%= p.username %></a> - <%= p.total_activity %> hrs
            </li>
          <% }) %>
        <% } else { %>
          <li>No active players found.</li>
        <% } %>
      </ul>
    </section>

    <!-- Next 3 Shifts -->
    <section>
      <h2>Next 3 Shifts</h2>
      <% if (upcomingShifts && upcomingShifts.length > 0) { %>
        <ul>
          <% upcomingShifts.forEach(shift => { %>
            <li>
              Host: <%= shift.host %>
              <% if (shift.cohost) { %> Cohost: <%= shift.cohost %> <% } %>
              <% if (shift.overseer) { %> Overseer: <%= shift.overseer %> <% } %>
              Time: <span class="shift-time" data-timestamp="<%= shift.time.getTime() %>"></span>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p>No upcoming shifts.</p>
      <% } %>
    </section>
  </main>

  <script>
    const searchBar = document.getElementById('searchBar');
    const searchResults = document.getElementById('searchResults');

    // Search functionality
    searchBar.addEventListener('input', async () => {
      const query = searchBar.value.trim();
      if (!query) {
        searchResults.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(`/dashboard/search?username=${encodeURIComponent(query)}`);
        const data = await res.json();

        searchResults.innerHTML = data.length
          ? data.map(p => `<div><a href="/dashboard/player/${p.username}">${p.username}</a></div>`).join('')
          : '<div>No players found.</div>';
      } catch (err) {
        console.error('Search error:', err);
        searchResults.innerHTML = '<div>Error fetching results.</div>';
      }
    });

    // Convert timestamps to human-readable
    document.querySelectorAll('.shift-time').forEach(span => {
      const timestamp = parseInt(span.dataset.timestamp, 10);
      const date = new Date(timestamp);
      span.textContent = date.toLocaleString(); // You can customize format here
    });
  </script>
</body>
</html>
