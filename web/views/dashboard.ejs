<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Mochi Bar Dashboard</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: 'Roboto', sans-serif;
Â  Â  Â  margin: 0;
Â  Â  Â  background: #f7f9fc; /* Light background from your recent designs */
Â  Â  Â  color: #000;
Â  Â  }

Â  Â  header {
Â  Â  Â  /* Blue header from player profile mockups */
Â  Â  Â  background: #42b4ff; 
Â  Â  Â  color: black; 
Â  Â  Â  font-weight: 700;
Â  Â  Â  font-size: 48px;
Â  Â  Â  padding: 25px 40px;
Â  Â  Â  text-align: left;
Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
Â  Â  }

Â  Â  .container {
Â  Â  Â  max-width: 1200px;
Â  Â  Â  margin: 40px auto;
Â  Â  Â  padding: 0 20px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 40px;
Â  Â  }

Â  Â  h2 {
Â  Â  Â  font-size: 26px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  text-align: left; /* Align sections left like player info */
Â  Â  Â  color: #333;
Â  Â  }
    
    /* --- General Content Blocks --- */
    .content-section {
        background: #fff; /* White blocks from mockups */
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #ddd;
    }

Â  Â  /* ğŸ” Search Bar */
Â  Â  .search-wrapper {
Â  Â  Â  position: relative;
Â  Â  Â  margin-bottom: 20px; 
      max-width: 500px;
Â  Â  }
Â  Â  .search-wrapper input {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px 15px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  outline: none;
Â  Â  Â  box-sizing: border-box;
Â  Â  }
    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #ccc;
        max-height: 250px;
        overflow-y: auto;
        z-index: 10;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .suggestion-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: #f0f0f0; }
    .suggestion-item img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

Â  Â  /* ğŸ† Top Players Grid */
Â  Â  .top-players-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
Â  Â  Â  gap: 15px;
Â  Â  }
Â  Â  .player-card {
Â  Â  Â  background: #f9f9f9; /* Slightly darker than block for contrast */
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 15px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
    .player-card:hover {
        background: #e9e9e9;
    }
Â  Â  .player-card img {
Â  Â  Â  width: 60px;
Â  Â  Â  height: 60px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .player-card .time {
Â  Â  Â  font-size: 0.9em;
Â  Â  Â  font-weight: 500;
Â  Â  Â  color: #555;
Â  Â  }
    .player-card .live-status {
        color: #28a745; 
        font-weight: 700;
        font-size: 0.75em;
        display: block;
        margin-bottom: 2px;
    }

Â  Â  /* ğŸ“… Upcoming Shifts */
Â  Â  .shifts-list {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 10px;
Â  Â  }

Â  Â  .shift-item {
Â  Â  Â  background: #f0f0f0; /* Use a light gray block for items */
Â  Â  Â  padding: 12px 15px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-weight: 500;
Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  }

Â  Â  .shift-time {
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #42b4ff;
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 5px;
Â  Â  }

Â  Â  .no-data {
Â  Â  Â  background: #f9f9f9;
Â  Â  Â  padding: 15px;
Â  Â  Â  text-align: center;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-weight: 500;
Â  Â  Â  color: #777;
Â  Â  Â  border: 1px solid #eee;
Â  Â  }

Â  Â  @media (max-width: 600px) {
Â  Â  Â  header {
Â  Â  Â  Â  font-size: 36px;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }
Â  Â  Â  h2 {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>Mochi Bar Database</header>

Â  <div class="container">

    <section class="content-section">
Â  Â  Â  <h2>Player Lookup</h2>
Â  Â  Â  <div class="search-wrapper">
Â  Â  Â  Â  <input type="text" id="playerSearch" placeholder="Search Roblox username...">
Â  Â  Â  Â  <div id="suggestions" class="suggestions"></div>
Â  Â  Â  </div>
    </section>

Â  Â  <section class="content-section">
Â  Â  Â  <h2>Top Active This Week</h2>
Â  Â  Â  <div id="topPlayersGrid" class="top-players-grid">
Â  Â  Â  Â  <% if (!topPlayers || topPlayers.length === 0) { %>
Â  Â  Â  Â  Â  <div class="no-data" style="grid-column: 1 / -1;">No active players data.</div>
Â  Â  Â  Â  <% } %>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <section class="content-section">
Â  Â  Â  <h2>Upcoming Shifts (Discord)</h2>
Â  Â  Â  <div id="shiftsList" class="shifts-list">
Â  Â  Â  Â  <div class="no-data">Loading upcoming shifts...</div>
Â  Â  Â  </div>
Â  Â  </section>

Â  </div>

Â  <script>
Â  Â  const input = document.getElementById('playerSearch');
Â  Â  const suggestionsBox = document.getElementById('suggestions');
Â  Â  const shiftsList = document.getElementById('shiftsList');
    const topPlayersGrid = document.getElementById('topPlayersGrid');
    
    // Load data from EJS variable
    let topPlayersData = JSON.parse('<%- JSON.stringify(topPlayers || []) %>');

Â  Â  // --- Player Search (Functionality Retained) ---
Â  Â  input.addEventListener('input', async () => {
Â  Â  Â  const q = input.value.trim();
Â  Â  Â  if (!q) {
Â  Â  Â  Â  suggestionsBox.innerHTML = '';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`/dashboard/search?username=${encodeURIComponent(q)}`);
Â  Â  Â  Â  const players = await res.json();
Â  Â  Â  Â  
Â  Â  Â  Â  suggestionsBox.innerHTML = players.map(p => `
Â  Â  Â  Â  Â  <div class="suggestion-item" onclick="window.location='/dashboard/player/${p.username}'">
Â  Â  Â  Â  Â  Â  <img src="https://www.roblox.com/headshot-thumbnail/image?userId=${p.roblox_id}&width=40&height=40&format=png" 
                 onerror="this.src='https://placehold.co/40x40/e0e6f0/5f6c7b?text=U';" />
Â  Â  Â  Â  Â  Â  <span>${p.username}</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `).join('');
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Search error:", err);
        suggestionsBox.innerHTML = '';
Â  Â  Â  }
Â  Â  });

Â  Â  document.addEventListener('click', e => {
Â  Â  Â  if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
Â  Â  Â  Â  suggestionsBox.innerHTML = '';
Â  Â  Â  }
Â  Â  });

Â  Â  // --- Top Players Live Update Logic (Functionality Retained) ---
    
Â  Â  function calculateLiveMinutes(player) {
Â  Â  Â  const startTime = player.ongoing_session_start_time;
Â  Â  Â  if (startTime) {
Â  Â  Â  Â  const sessionStartTimeMs = new Date(startTime).getTime(); 
Â  Â  Â  Â  if (!isNaN(sessionStartTimeMs) && sessionStartTimeMs > 0) {
Â  Â  Â  Â  Â  const elapsedMs = Date.now() - sessionStartTimeMs;
Â  Â  Â  Â  Â  if (elapsedMs > 0) {
                return elapsedMs / 1000 / 60;
            }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return 0;
Â  Â  }

Â  Â  function getTotalMinutes(player) {
Â  Â  Â  const weekly = player.weekly_minutes || 0;
Â  Â  Â  const liveMinutes = calculateLiveMinutes(player); 
Â  Â  Â  return weekly + liveMinutes;
Â  Â  }

    function formatMinutes(totalMinutes) {
        if (totalMinutes < 1) return '0 min';
        const totalMinutesInt = Math.round(totalMinutes);
        const h = Math.floor(totalMinutesInt / 60);
        const m = totalMinutesInt % 60;
        if (h > 0) {
            return `${h} hr ${m} min`;
        }
        return `${m} min`;
    }

    function renderTopPlayers() {
        if (topPlayersData.length === 0) {
            topPlayersGrid.innerHTML = `<div class="no-data" style="grid-column: 1 / -1;">No active players data.</div>`;
            return;
        }

        const livePlayers = topPlayersData.map(p => ({
            ...p,
            live_total_minutes: getTotalMinutes(p),
            is_live: calculateLiveMinutes(p) > 0
        }));

        livePlayers.sort((a, b) => b.live_total_minutes - a.live_total_minutes);

        // Render the top 8 players, matching the grid capacity
        const html = livePlayers.slice(0, 8).map(p => {
            const avatarUrl = `https://www.roblox.com/headshot-thumbnail/image?userId=${p.roblox_id}&width=60&height=60&format=png`;
            return `
                <div class="player-card" onclick="window.location='/dashboard/player/${p.username}'">
                    <img src="${avatarUrl}" alt="Avatar" onerror="this.src='https://placehold.co/60x60/e0e6f0/5f6c7b?text=U';" />
                    <div>${p.username}</div>
                    ${p.is_live ? '<span class="live-status">LIVE</span>' : ''}
                    <div class="time">${formatMinutes(p.live_total_minutes)}</div>
                </div>
            `;
        }).join('');

        topPlayersGrid.innerHTML = html;
    }
    
    renderTopPlayers();
    setInterval(renderTopPlayers, 5000); 


Â  Â  // --- Shifts (Functionality Retained) ---
Â  Â  function formatShiftTime(timestamp) {
Â  Â  Â  const d = new Date(timestamp * 1000);
Â  Â  Â  const dateStr = d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
Â  Â  Â  const timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
Â  Â  Â  return `${dateStr} @ ${timeStr}`;
Â  Â  }

Â  Â  async function loadShifts() {
Â  Â  Â  shiftsList.innerHTML = `<div class="no-data">Fetching data from Discord...</div>`;
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/sessions');
Â  Â  Â  Â  const sessions = await res.json();
Â  Â  Â  Â  const now = Math.floor(Date.now() / 1000);
Â  Â  Â  Â  const upcoming = sessions.filter(s => s.time > now).sort((a,b)=>a.time-b.time);

Â  Â  Â  Â  if (upcoming.length === 0) {
Â  Â  Â  Â  Â  shiftsList.innerHTML = `<div class="no-data">No upcoming shifts are currently scheduled.</div>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  shiftsList.innerHTML = '';
Â  Â  Â  Â  upcoming.forEach(session => {
Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  div.className = 'shift-item';
Â  Â  Â  Â  Â  let hosts = `Host: ${session.host}`;
Â  Â  Â  Â  Â  if (session.cohost) hosts += ` | Co-Host: ${session.cohost}`;
Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  <span class="shift-time">${formatShiftTime(session.time)}</span>
Â  Â  Â  Â  Â  Â  ${hosts}
Â  Â  Â  Â  Â  Â  ${session.overseer ? `<br>Overseer: ${session.overseer}` : ''}
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  shiftsList.appendChild(div);
Â  Â  Â  Â  });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  shiftsList.innerHTML = `<div class="no-data" style="color:red;">Failed to load scheduled shifts.</div>`;
Â  Â  Â  }
Â  Â  }

Â  Â  loadShifts();
Â  </script>
</body>
</html>
