<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mochi Bar Staff Dashboard - Home</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://i.ibb.co/S4NjLxNL/Gemini-Generated-Image-hbcyjkhbcyjkhbcy-removebg-preview.png">
<style>
  body { font-family: 'Roboto', sans-serif; margin:0; background:#f7f9fc; color:#000; }
  header {
    background: linear-gradient(90deg, #42b4ff, #1a85e6, #42b4ff, #1a85e6);
    background-size: 300% 100%;
    animation: gradientFlow 6s ease infinite;
    color:white; font-weight:700; font-size:48px; padding:25px 40px; text-align:center;
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
  }
  @keyframes gradientFlow { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
  .nav-tabs {
    background:white; display:flex; justify-content:space-between; align-items:center;
    gap:10px; padding:15px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-bottom:2px solid #e0e6f0; flex-wrap:wrap;
  }
  .nav-buttons { display:flex; gap:10px; flex-wrap:wrap; }
  .tab-button { display:flex; align-items:center; gap:8px; padding:12px 24px; background:transparent; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; color:#555; transition:all 0.3s; }
  .tab-button:hover { background:#f0f8ff; color:#42b4ff; }
  .tab-button.active { background:#42b4ff; color:white; }
  .search-wrapper { position:relative; max-width:300px; flex-grow:1; }
  .search-wrapper input { width:100%; padding:10px 15px; font-size:15px; border:1px solid #ccc; border-radius:8px; outline:none; box-sizing:border-box; transition:border 0.2s; }
  .search-wrapper input:focus { border-color:#42b4ff; }
  .suggestions { position:absolute; top:100%; left:0; width:100%; background:white; border:1px solid #ccc; max-height:250px; overflow-y:auto; z-index:10; border-radius:0 0 8px 8px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  .suggestion-item { display:flex; align-items:center; padding:10px 12px; cursor:pointer; border-bottom:1px solid #eee; transition:background 0.2s; }
  .suggestion-item:last-child { border-bottom:none; }
  .suggestion-item:hover { background:#f0f8ff; }
  .suggestion-item img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
  .no-data { text-align:center; color:#888; padding:20px; font-style:italic; }
  .top-players-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:20px; justify-items:center; }
  .player-card { background:#f9f9f9; text-align:center; padding:15px; border-radius:12px; font-weight:600; cursor:pointer; border:1px solid #eee; transition:transform 0.2s, box-shadow 0.2s; width:100%; max-width:220px; }
  .player-card:hover { transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.1); }
  .player-card img { width:80px; height:80px; border-radius:50%; margin-bottom:10px; object-fit:cover; background:#e0e6f0; }
  .player-card .avatar-wrapper { position:relative; display:inline-block; }
  .player-card .birthday-badge { position:absolute; bottom:0; right:0; background:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
  .player-card .time { font-size:0.9em; font-weight:500; color:#555; margin-top:4px; }
  .player-card .live-status { color:#28a745; font-weight:700; font-size:0.8em; display:block; margin-bottom:4px; }
  .container { max-width:1200px; margin:40px auto; padding:0 20px; display:flex; flex-direction:column; gap:40px; }
  h2 { font-size:26px; font-weight:700; margin-bottom:20px; color:#333; }
  .content-section { background:#fff; padding:20px; border-radius:12px; box-shadow:0 6px 15px rgba(0,0,0,0.05); border:1px solid #ddd; }
  .announcement-box { background:#f0f8ff; border-left:4px solid #42b4ff; padding:15px; border-radius:8px; margin-bottom:15px; }
  .announcement-title { font-weight:700; font-size:18px; color:#1a85e6; margin-bottom:8px; }
  .announcement-content {
    margin-bottom: 10px;
    white-space: pre-wrap; /* This preserves line breaks and spaces */
    word-wrap: break-word;
  }
  .announcement-meta { display:flex; justify-content:space-between; font-size:12px; color:#666; }
  .announcement-actions { display:flex; gap:10px; justify-content:flex-end; }
  .user-requirements { background:#e6f3ff; border-radius:8px; padding:15px; margin-bottom:20px; border:1px solid #42b4ff; }
  .user-requirements-title { font-weight:700; color:#1a85e6; margin-bottom:10px; font-size:16px; }
  .user-requirement-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding:8px; background:white; border-radius:6px; }
  .user-requirement-label { font-weight:600; color:#333; }
  .user-requirement-progress { display:flex; align-items:center; gap:10px; }
  .progress-bar { width:100px; height:8px; background:#e0e6f0; border-radius:4px; overflow:hidden; }
  .progress-fill { height:100%; background:#42b4ff; transition:width 0.3s; }
  .progress-text { font-size:12px; font-weight:600; color:#666; min-width:40px; text-align:right; }
  .progress-complete { color:#28a745; }
  .progress-incomplete { color:#ff4444; }
  .home-section { margin-bottom:30px; }
  .home-section-title { font-size:22px; font-weight:700; color:#1a85e6; margin-bottom:15px; display:flex; align-items:center; gap:10px; }
  .home-section-title-icon { font-size:24px; }
  .home-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; }
  .requirement-tag { display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f9f9f9; border-radius:8px; margin-bottom:10px; border-left:4px solid #42b4ff; }
  .requirement-tag-name { font-weight:600; color:#333; }
  .requirement-tag-desc { font-size:14px; color:#666; margin-top:4px; }
  .requirement-tag-count { background:#42b4ff; color:white; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:700; }
  .btn { padding:10px 20px; background:#42b4ff; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s; }
  .btn:hover { background:#1a85e6; transform:translateY(-2px); }
  .btn.small { padding:6px 12px; font-size:14px; }
  .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); animation:fadeIn 0.3s; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .modal-content { background-color:white; margin:5% auto; padding:0; border-radius:12px; width:90%; max-width:600px; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:slideIn 0.3s; max-height:85vh; overflow-y:auto; }
  @keyframes slideIn { from{transform:translateY(-50px);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal-header { display:flex; justify-content:space-between; align-items:center; padding:25px 30px; border-bottom:2px solid #42b4ff; background:linear-gradient(135deg,#f0f8ff 0%,#e6f3ff 100%); }
  .modal-title { font-size:24px; font-weight:700; color:#1a85e6; }
  .close { color:#aaa; font-size:32px; font-weight:bold; cursor:pointer; transition:color 0.2s; line-height:1; }
  .close:hover { color:#333; }
  .modal-body { padding:25px 30px; }
  .announcement-form { display:flex; flex-direction:column; gap:15px; }
  .announcement-form input, .announcement-form textarea { width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; }
  .announcement-form textarea { min-height:100px; resize:vertical; }
  .announcement-form-actions { display:flex; justify-content:flex-end; gap:10px; }
  .announcements-modal-list { max-height:400px; overflow-y:auto; margin:15px 0; }
  .announcement-item {
    position: relative;
    padding-bottom: 20px;
  }
  .announcement-item .btn.small {
    padding: 4px 12px;
    font-size: 12px;
    margin-left: 10px;
  }
  
  /* Notification styles */
  .notification-container {
    position: relative;
    display: flex;
    align-items: center;
  }
  .notification-icon {
    font-size: 24px;
    cursor: pointer;
    position: relative;
    color: #555;
    transition: color 0.3s;
  }
  .notification-icon:hover {
    color: #42b4ff;
  }
  .notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }
  .notification-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    max-height: 400px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow-y: auto;
    display: none;
  }
  .notification-dropdown.show {
    display: block;
  }
  .notification-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background 0.2s;
  }
  .notification-item:hover {
    background: #f0f8ff;
  }
  .notification-item:last-child {
    border-bottom: none;
  }
  .notification-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
  }
  .notification-message {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
  }
  .notification-action {
    font-size: 13px;
    color: #42b4ff;
    font-weight: 500;
  }
  .notification-time {
    font-size: 12px;
    color: #888;
    text-align: right;
  }
  .notification-empty {
    padding: 20px;
    text-align: center;
    color: #888;
    font-style: italic;
  }
  
  @media(max-width:600px){
    header { font-size:36px; padding:20px; }
    h2 { text-align:center; }
    .top-players-grid { grid-template-columns:1fr; }
    .nav-tabs { flex-direction:column; gap:10px; }
    .nav-buttons { width:100%; justify-content:center; flex-wrap:wrap; }
    .search-wrapper { width:100%; max-width:100%; }
    .tab-button { padding:10px 16px; font-size:14px; }
    .modal-content { margin:5% auto; width:95%; }
    .modal-header, .modal-body { padding:20px; }
    .home-grid { grid-template-columns:1fr; }
    .user-requirement-progress { flex-direction:column; align-items:flex-start; gap:5px; }
    .progress-bar { width:100%; }
    .notification-dropdown {
      width: 300px;
      right: -10px;
    }
  }
</style>
</head>
<body>
<header>Mochi Bar Staff Dashboard</header>
<nav class="nav-tabs">
  <div class="nav-buttons">
    <button class="tab-button active" data-tab="home"><span class="tab-icon">üëã</span>Home</button>
    <a href="/dashboard/playerlist" class="tab-button"><span class="tab-icon">‚≠êÔ∏è</span>Player List</a>
    <a href="/dashboard/shifts" class="tab-button"><span class="tab-icon">üóìÔ∏è</span>Shifts</a>
    <a href="/dashboard/account" class="tab-button"><span class="tab-icon">üí´</span>My Account</a>
    <a href="/dashboard/settings" class="tab-button"><span class="tab-icon">üîó</span>Settings</a>
  </div>
  <div class="search-wrapper">
    <input type="text" id="playerSearch" placeholder="Search Roblox username...">
    <div id="suggestions" class="suggestions"></div>
  </div>
  <div class="notification-container">
    <div class="notification-icon" id="notificationIcon">
      üîî
      <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
    </div>
    <div class="notification-dropdown" id="notificationDropdown">
      <div class="notification-empty">No notifications</div>
    </div>
  </div>
</nav>
<div class="container">
  <div id="home" class="tab-content active">
    <!-- Important Section -->
    <div class="home-section">
      <h2 class="home-section-title"><span class="home-section-title-icon">‚ùóÔ∏è</span>Important</h2>
      <div class="home-grid">
        <section class="content-section">
          <h2>üìç Announcements</h2>
          <div id="announcementsContainer">
            <div id="latestAnnouncement" class="announcement-box"></div>
            <div class="announcement-actions">
              <button id="viewAllAnnouncementsBtn" class="btn">View All</button>
              <button id="newAnnouncementBtn" class="btn" style="display:none;">New Announcement</button>
            </div>
          </div>
        </section>
        <section class="content-section">
          <h2>‚ú® Weekly Requirements</h2>
          <div id="userRequirements" class="user-requirements" style="display:none;">
            <div class="user-requirements-title">Your Weekly Requirements</div>
            <div id="userRequirementsList"></div>
          </div>
          <div id="requirementsBox"></div>
        </section>
      </div>
    </div>
    
    <!-- Community Section -->
    <div class="home-section">
      <h2 class="home-section-title"><span class="home-section-title-icon">üçÄ</span>Community</h2>
      <div class="home-grid">
        <section class="content-section"><h2>üèÖ Top 3 active this week!</h2><div id="topPlayersGrid" class="top-players-grid"></div></section>
        <section class="content-section"><h2>üèÖ Top 3 shifts this week!</h2><div id="topShiftLeaders" class="top-players-grid"></div></section>
        <section class="content-section"><h2>üéÇ Upcoming birthdays!</h2><div id="upcomingBirthdays" class="top-players-grid"></div></section>
      </div>
    </div>
  </div>
</div>

<div id="announcementsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title">üìç Announcements</span>
      <span class="close" onclick="closeAnnouncementsModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="announcementsModalList" class="announcements-modal-list"></div>
    </div>
  </div>
</div>

<div id="newAnnouncementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title">New Announcement</span>
      <span class="close" onclick="closeNewAnnouncementModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="announcementForm" class="announcement-form">
        <input type="text" id="announcementTitle" placeholder="Announcement Title" required>
        <textarea id="announcementContent" placeholder="Announcement Content" required></textarea>
        <div class="announcement-form-actions">
          <button type="button" class="btn" onclick="closeNewAnnouncementModal()">Cancel</button>
          <button type="submit" class="btn">Post Announcement</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="/notification.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('playerSearch');
  const suggestionsBox = document.getElementById('suggestions');
  const topPlayersGrid = document.getElementById('topPlayersGrid');
  const latestAnnouncement = document.getElementById('latestAnnouncement');
  const newAnnouncementBtn = document.getElementById('newAnnouncementBtn');
  const viewAllAnnouncementsBtn = document.getElementById('viewAllAnnouncementsBtn');
  const userRequirements = document.getElementById('userRequirements');
  const userRequirementsList = document.getElementById('userRequirementsList');
  
  // Add event listeners for announcement buttons
  viewAllAnnouncementsBtn.addEventListener('click', openAnnouncementsModal);
  newAnnouncementBtn.addEventListener('click', openNewAnnouncementModal);
  document.getElementById('announcementForm').addEventListener('submit', submitNewAnnouncement);

  let currentUser = null;
  let userGroupRank = '';
  let allPlayersData = [];
  let playerShiftStats = {};
  let announcements = [];
  let currentUserLabels = [];

  const LEADERSHIP_RANKS = [
    'Chairman', 'Vice Chairman', 'Chief Administrative Officer', 'Leadership Overseer',
    'Chief of Operations', 'Chief of Human Resources', 'Chief Of Public Relations'
  ];
  const EXECUTIVE_RANKS = ['Chairman', 'Vice Chairman'];
  const DIRECTOR_PLUS = [
    'Chairman', 'Vice Chairman', 'Chief Administrative Officer', 'Leadership Overseer',
    'Chief of Operations', 'Chief of Human Resources', 'Chief Of Public Relations',
    'Head Corporate', 'Senior Corporate', 'Junior Corporate', 'Corporate Intern',
    'Lead Mochi Director', 'Senior Mochi Director', 'Mochi Director'
  ];
  const SUPERVISION_PLUS = [
    'Chairman', 'Vice Chairman', 'Chief Administrative Officer', 'Leadership Overseer',
    'Chief of Operations', 'Chief of Human Resources', 'Chief Of Public Relations',
    'Head Corporate', 'Senior Corporate', 'Junior Corporate', 'Corporate Intern',
    'Lead Mochi Director', 'Senior Mochi Director', 'Mochi Director', 'Mochi Manager',
    'Assistant Mochi Director', 'Supervisor', 'Mochi Leader'
  ];
  
  // Rank hierarchy for sorting
  const RANK_HIERARCHY = {
    'Chairman': 100,
    'Vice Chairman': 90,
    'Chief Administrative Officer': 85,
    'Leadership Overseer': 84,
    'Chief of Operations': 80,
    'Chief of Human Resources': 79,
    'Chief Of Public Relations': 78,
    'Head Corporate': 70,
    'Senior Corporate': 60,
    'Junior Corporate': 50,
    'Corporate Intern': 40,
    'Lead Mochi Director': 35,
    'Senior Mochi Director': 30,
    'Mochi Director': 25,
    'Mochi Manager': 20,
    'Assistant Mochi Director': 15,
    'Supervisor': 14,
    'Mochi Leader': 13,
    'Senior Mochi': 12,
    'Mochi': 11,
    'Junior Mochi': 10,
    'Intern': 5,
    'Trainee': 1
  };

  // Function to show loading indicator
  function showLoading(element) {
    if (!element) return;
    
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'loading-overlay';
    loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
    
    // Make the parent container relative if it's not already
    if (element.style.position !== 'relative' && element.style.position !== 'absolute') {
      element.style.position = 'relative';
    }
    
    element.appendChild(loadingOverlay);
    return loadingOverlay;
  }
  
  // Function to hide loading indicator
  function hideLoading(loadingOverlay) {
    if (loadingOverlay && loadingOverlay.parentNode) {
      loadingOverlay.parentNode.removeChild(loadingOverlay);
    }
  }

  async function loadCurrentUser() {
    try {
      console.log('Loading current user...');
      const response = await fetch('/dashboard/current-user');
      
      if (!response.ok) {
        console.error('Failed to fetch user:', response.status, response.statusText);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      currentUser = data;
      userGroupRank = currentUser.group_rank || '';
      
      console.log('Current user loaded:', currentUser);
      console.log('User rank:', userGroupRank);
      console.log('All leadership ranks:', LEADERSHIP_RANKS);
      console.log('Is user in leadership?', LEADERSHIP_RANKS.includes(userGroupRank));
      
      updateTabAccess();
      renderMyAccount();
      loadAnnouncements();
      
      // Load user labels FIRST, then render requirements
      await loadCurrentUserLabels();
      console.log('Labels loaded:', currentUserLabels);
      
      // Now render the requirements box directly (without setTimeout)
      renderRequirementsBox();
      
      // Initialize notifications after user is loaded
      if (window.NotificationManager) {
        window.NotificationManager.init(currentUser.roblox_id);
      }
    } catch (err) {
      console.error('Failed to load current user:', err);
      userGroupRank = '';
    }
  }
  
  async function loadCurrentUserLabels() {
    if (!currentUser) return;
    
    try {
      const res = await fetch(`/settings/labels/${currentUser.roblox_id}`);
      if (res.ok) {
        currentUserLabels = await res.json();
      } else {
        currentUserLabels = [];
      }
    } catch (err) {
      console.error('Failed to load user labels:', err);
      currentUserLabels = [];
    }
  }
  
  async function loadAnnouncements() {
    try {
      console.log('Loading announcements...');
      const response = await fetch('/dashboard/announcements');
      
      if (!response.ok) {
        console.error('Failed to fetch announcements:', response.status, response.statusText);
        announcements = [];
        return;
      }
      
      const data = await response.json();
      announcements = Array.isArray(data) ? data : [];
      
      console.log('Announcements loaded:', announcements);
      renderLatestAnnouncement();
      
      // Show the new announcement button for leadership
      if (LEADERSHIP_RANKS.includes(userGroupRank)) {
        newAnnouncementBtn.style.display = 'block';
      }
    } catch (err) {
      console.error('Failed to load announcements:', err);
      announcements = [];
    }
  }
  
  function renderLatestAnnouncement() {
    if (!announcements || announcements.length === 0) {
      latestAnnouncement.innerHTML = '<p>No announcements available.</p>';
      return;
    }
    
    const latest = announcements[0];
    if (!latest) {
      latestAnnouncement.innerHTML = '<p>No announcements available.</p>';
      return;
    }
    
    // Handle different date field names
    const date = latest.date || latest.created_at || latest.timestamp;
    const announcementDate = date ? new Date(date) : new Date();
    
    latestAnnouncement.innerHTML = `
      <div class="announcement-title">${latest.title || 'No Title'}</div>
      <div class="announcement-content">${latest.content || 'No content available'}</div>
      <div class="announcement-meta">
        <span>By: ${latest.author || 'Unknown'}</span>
        <span>${announcementDate.toLocaleDateString()}</span>
      </div>
    `;
  }
  
  function openAnnouncementsModal() {
    const modal = document.getElementById('announcementsModal');
    const modalList = document.getElementById('announcementsModalList');
    
    modalList.innerHTML = '';
    
    if (!announcements || announcements.length === 0) {
      modalList.innerHTML = '<p>No announcements available.</p>';
    } else {
      announcements.forEach((announcement, index) => {
        const date = announcement.date || announcement.created_at || announcement.timestamp;
        const announcementDate = date ? new Date(date) : new Date();
        const item = document.createElement('div');
        item.className = 'announcement-item';
        
        // Check if current user can delete announcements
        const canDelete = LEADERSHIP_RANKS.includes(userGroupRank);
        
        item.innerHTML = `
          <div class="announcement-title">${announcement.title || 'No Title'}</div>
          <div class="announcement-content" style="white-space: pre-wrap;">${announcement.content || 'No content'}</div>
          <div class="announcement-meta">
            <span>By: ${announcement.author || 'Unknown'}</span>
            <span>${announcementDate.toLocaleDateString()}</span>
          </div>
          ${canDelete ? `
            <div style="margin-top:10px;text-align:right;">
              <button class="btn small" onclick="deleteAnnouncementByIndex(${index})" style="background:#ff4444;">
                Delete
              </button>
            </div>
          ` : ''}
       `;
        modalList.appendChild(item);
      });
    }
    
    modal.style.display = 'block';
  }

  function closeAnnouncementsModal() {
    document.getElementById('announcementsModal').style.display = 'none';
  }

  // Make closeAnnouncementsModal and closeNewAnnouncementModal globally accessible
  window.closeAnnouncementsModal = closeAnnouncementsModal;
  window.closeNewAnnouncementModal = closeNewAnnouncementModal;

  // Add event listener for clicking outside the modal to close it
  window.addEventListener('click', function(e) {
    const announcementsModal = document.getElementById('announcementsModal');
    const newAnnouncementModal = document.getElementById('newAnnouncementModal');
    
    if (e.target === announcementsModal) {
      closeAnnouncementsModal();
    }
    
    if (e.target === newAnnouncementModal) {
      closeNewAnnouncementModal();
    }
  });

  function openNewAnnouncementModal() {
    document.getElementById('newAnnouncementModal').style.display = 'block';
  }

  function closeNewAnnouncementModal() {
    document.getElementById('newAnnouncementModal').style.display = 'none';
  }

  async function submitNewAnnouncement(event) {
    event.preventDefault();
    
    const title = document.getElementById('announcementTitle').value;
    const content = document.getElementById('announcementContent').value;
    
    if (!title || !content) return;
    
    try {
      console.log('Submitting announcement:', { title, content, author: currentUser.username });
      
      const response = await fetch('/dashboard/announcements', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          content,
          author: currentUser.username
        })
      });
      
      if (!response.ok) {
        console.error('Failed to save announcement:', response.status, response.statusText);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const newAnnouncement = await response.json();
      console.log('New announcement created:', newAnnouncement);
      
      // Add to the beginning of the array
      announcements.unshift(newAnnouncement);
      
      // Update the UI
      renderLatestAnnouncement();
      
      // Close the modal and reset form
      closeNewAnnouncementModal();
      document.getElementById('announcementForm').reset();
    } catch (error) {
      console.error('Error saving announcement:', error);
      alert('Failed to save announcement. Please try again.');
    }
  }

  // Add this new function to handle deletion by index
  window.deleteAnnouncementByIndex = function(index) {
    const announcement = announcements[index];
    if (!announcement) {
      console.error('Announcement not found at index:', index);
      return;
    }
    
    if (!confirm('Are you sure you want to delete this announcement?')) {
      return;
    }
    
    try {
      console.log('Deleting announcement at index:', index);
      
      // Try using ID first, then fall back to title and date
      const deleteData = announcement.id 
        ? { id: announcement.id }
        : { 
            title: announcement.title, 
            date: announcement.date || announcement.created_at || announcement.timestamp
          };
      
      fetch('/dashboard/announcements', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(deleteData)
      })
      .then(response => {
        if (!response.ok) {
          console.error('Failed to delete announcement:', response.status, response.statusText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Remove the announcement from the local array
        announcements.splice(index, 1);
        
        // Refresh the modal
        openAnnouncementsModal();
        
        // If this was the latest announcement, refresh the home view
        if (announcements.length === 0) {
          latestAnnouncement.innerHTML = '<p>No announcements available.</p>';
        } else {
          renderLatestAnnouncement();
        }
      })
      .catch(error => {
        console.error('Error deleting announcement:', error);
        alert('Error deleting announcement. Please try again.');
      });
    } catch (error) {
      console.error('Error in deleteAnnouncementByIndex:', error);
      alert('Error deleting announcement. Please try again.');
    }
  };

  function updateTabAccess() {
    const playerlistTab = document.querySelector('[data-tab="playerlist"]');
    const settingsTab = document.querySelector('[data-tab="settings"]');

    console.log('Updating tab access for rank:', userGroupRank);
    console.log('Leadership ranks:', LEADERSHIP_RANKS);
    console.log('Is leadership?', LEADERSHIP_RANKS.includes(userGroupRank));

    if (playerlistTab) {
      if (!LEADERSHIP_RANKS.includes(userGroupRank)) {
        playerlistTab.style.opacity = '0.5';
        playerlistTab.style.cursor = 'not-allowed';
        playerlistTab.title = 'Requires Mochi Director+';
        playerlistTab.dataset.disabled = 'true';
      } else {
        playerlistTab.style.opacity = '1';
        playerlistTab.style.cursor = 'pointer';
        playerlistTab.title = '';
        playerlistTab.dataset.disabled = 'false';
        
        // Preload player list data when user has access
        setTimeout(() => {
          if (!allPlayersData.length) {
            loadPlayerList();
          }
        }, 1000);
      }
    }

    if (settingsTab) {
      if (!EXECUTIVE_RANKS.includes(userGroupRank)) {
        settingsTab.style.opacity = '0.5';
        settingsTab.style.cursor = 'not-allowed';
        settingsTab.title = 'Requires Vice Chairman+';
        settingsTab.dataset.disabled = 'true';
      } else {
        settingsTab.style.opacity = '1';
        settingsTab.style.cursor = 'pointer';
        settingsTab.title = '';
        settingsTab.dataset.disabled = 'false';
      }
    }
  }

  loadCurrentUser();

  input.addEventListener('input', async () => {
    const q = input.value.trim();
    if (!q) { suggestionsBox.innerHTML = ''; return; }
    try {
      const res = await fetch(`/dashboard/search?username=${encodeURIComponent(q)}`);
      const players = res.ok ? await res.json() : [];
      suggestionsBox.innerHTML = players.map(p => `
        <div class="suggestion-item" onclick="window.location='/dashboard/player/${p.username}'">
          <img src="https://www.roblox.com/headshot-thumbnail/image?userId=${p.roblox_id}&width=40&height=40&format=png"
               onerror="this.src='https://placehold.co/40x40/e0e6f0/5f6c7b?text=U';"/>
          <span>${p.username}</span>
        </div>`).join('');
    } catch (err) { suggestionsBox.innerHTML = ''; console.error(err); }
  });
  
  document.addEventListener('click', e => {
    if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) suggestionsBox.innerHTML = '';
  });

  let topPlayersData = [];

  function calculateLiveMinutes(player){
    if(player.ongoing_session_start_time){
      const elapsed = Date.now() - new Date(player.ongoing_session_start_time).getTime();
      return elapsed > 0 ? elapsed / 1000 / 60 : 0;
    }
    return 0;
  }

  function getTotalMinutes(player){ return (player.weekly_minutes || 0) + calculateLiveMinutes(player); }

  function formatMinutes(total){
    if(total < 1) return '0 min';
    const mins = Math.round(total), h = Math.floor(mins / 60), m = mins % 60;
    return h > 0 ? `${h} hr ${m} min` : `${m} min`;
  }

  async function renderTopPlayers(){
    try{
      console.log('Loading top players...');
      const res = await fetch('/dashboard/top-players');
      topPlayersData = res.ok ? await res.json() : topPlayersData;
      if(!topPlayersData.length){
        topPlayersGrid.innerHTML = '<div class="no-data">No active players data.</div>';
        return;
      }
      const livePlayers = topPlayersData
        .map(p => ({...p, live_total_minutes: getTotalMinutes(p), is_live: calculateLiveMinutes(p) > 0}))
        .sort((a,b) => b.live_total_minutes - a.live_total_minutes)
        .slice(0,3);

      topPlayersGrid.innerHTML = livePlayers.map(p => `
        <div class="player-card" onclick="window.location='/dashboard/player/${p.username}'">
          <img src="${p.avatar_url || 'https://placehold.co/80x80/e0e6f0/5f6c7b?text=U'}"
               onerror="this.src='https://placehold.co/80x80/e0e6f0/5f6c7b?text=U';"/>
          <div>${p.username}</div>
          ${p.is_live ? '<span class="live-status">LIVE</span>' : ''}
          <div class="time">${formatMinutes(p.live_total_minutes)}</div>
        </div>`).join('');
    } catch(err){ 
      console.error('Error loading top players:', err); 
      topPlayersGrid.innerHTML = '<div class="no-data">Failed to load top players.</div>';
    }
  }
  renderTopPlayers();
  setInterval(renderTopPlayers, 5000);

  // Simple Levenshtein distance function
  function getLevenshteinDistance(a, b) {
    const matrix = Array.from({ length: a.length + 1 }, () => []);
    for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
    for (let j = 0; j <= b.length; j++) matrix[0][j] = j;

    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i-1] === b[j-1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i-1][j] + 1,
          matrix[i][j-1] + 1,
          matrix[i-1][j-1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  // Find closest username from a list
  function findClosestUsername(target, usernames) {
    target = target.toLowerCase();
    let closest = target;
    let minDistance = Infinity;

    usernames.forEach(name => {
      const distance = getLevenshteinDistance(target, name.toLowerCase());
      if (distance < minDistance) {
        minDistance = distance;
        closest = name;
      }
    });

    return closest;
  }

  async function renderTopShiftLeaders(){
    try{
      console.log('Loading shift leaders...');
      const shiftRes = await fetch('/shifts');
      const shifts = shiftRes.ok ? await shiftRes.json() : [];
      
      // Get current time
      const now = Date.now();
      
      // Filter only past shifts
      const pastShifts = shifts.filter(shift => {
        const shiftTime = shift.shift_time || shift.time;
        const timestamp = shiftTime.toString().length === 10 ? shiftTime * 1000 : shiftTime;
        return timestamp < now;
      });
      
      const attendeesPromises = pastShifts.map(async shift => {
        try {
          const res = await fetch(`/shifts/attendees?shiftId=${shift.id}`);
          return res.ok ? await res.json() : [];
        } catch { return []; }
      });
      
      const allAttendeesArrays = await Promise.all(attendeesPromises);
      
      const playersRes = await fetch('/dashboard/players');
      const allPlayers = playersRes.ok ? await playersRes.json() : [];
      const allUsernames = allPlayers.map(p => p.username);
      
      const participationCount = {};
      
      pastShifts.forEach((shift, index) => {
        const attendees = allAttendeesArrays[index];
        
        ['host', 'cohost', 'overseer'].forEach(role => {
          if (shift[role] && shift[role] !== 'TBD') {
            const closest = findClosestUsername(shift[role], allUsernames).toLowerCase();
            participationCount[closest] = (participationCount[closest] || 0) + 1;
          }
        });
        
        attendees.forEach(attendee => {
          const closest = findClosestUsername(attendee.username, allUsernames).toLowerCase();
            participationCount[closest] = (participationCount[closest] || 0) + 1;
        });
      });
      
      const sortedLeaders = Object.entries(participationCount)
        .map(([username, count]) => ({ username, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);
      
      const topShiftLeadersGrid = document.getElementById('topShiftLeaders');
      
      if(!sortedLeaders.length){
        topShiftLeadersGrid.innerHTML = '<div class="no-data">No shift participation data.</div>';
        return;
      }
      
      topShiftLeadersGrid.innerHTML = sortedLeaders.map(leader => {
        const player = allPlayers.find(p => p.username.toLowerCase() === leader.username);
        const avatarUrl = player?.avatar_url || 'https://placehold.co/80x80/e0e6f0/5f6c7b?text=U';
        const displayName = player?.username || leader.username;
        
        return `
          <div class="player-card" onclick="window.location='/dashboard/player/${displayName}'">
            <img src="${avatarUrl}" onerror="this.src='https://placehold.co/80x80/e0e6f0/5f6c7b?text=U';"/>
            <div>${displayName}</div>
            <div class="time">${leader.count} shift${leader.count !== 1 ? 's' : ''}</div>
          </div>`;
      }).join('');
      
    } catch(err){ 
      console.error('Error loading shift leaders:', err); 
      document.getElementById('topShiftLeaders').innerHTML = '<div class="no-data">Failed to load shift leaders.</div>';
    }
  }

  renderTopShiftLeaders();
  setInterval(renderTopShiftLeaders, 60000);

  // Add this entire function BEFORE calculateShiftStats (around line 934)
  async function renderUserRequirements() {
    if (!currentUser || !currentUserLabels.length) {
      userRequirements.style.display = 'none';
      return;
    }
    
    try {
      console.log('Rendering user requirements for labels:', currentUserLabels);
      
      const userRes = await fetch('/dashboard/players');
      const allPlayers = userRes.ok ? await userRes.json() : [];
      const freshUserData = allPlayers.find(p => p.roblox_id === currentUser.roblox_id);
      
      const stats = await calculateShiftStats();
      const userStats = stats[currentUser.username.toLowerCase()] || { hosted: 0, attended: 0 };
      
      const weeklyMinutes = freshUserData?.weekly_minutes || 0;
      
      const tagRequirements = {
        'Management': { type: 'shifts', action: 'attended', required: 2, current: userStats.attended },
        'Public Relations': { type: 'shifts', action: 'attended', required: 2, current: userStats.attended },
        'Operations': { type: 'shifts', action: 'hosted', required: 2, current: userStats.hosted },
        'Human Resources': { type: 'shifts', action: 'hosted', required: 2, current: userStats.hosted },
        'Supervision': { type: 'minutes', required: 90, current: weeklyMinutes }
      };
      
      let userRequirementsHTML = '';
      
      currentUserLabels.forEach(label => {
        if (tagRequirements[label]) {
          const req = tagRequirements[label];
          const progress = Math.min((req.current / req.required) * 100, 100);
          const isComplete = req.current >= req.required;
          
          let progressText = '';
          if (req.type === 'shifts') {
            progressText = `${req.current}/${req.required} shifts ${req.action}`;
          } else {
            progressText = `${req.current}/${req.required} minutes`;
          }
          
          userRequirementsHTML += `
            <div class="user-requirement-item">
              <span class="user-requirement-label">${label}</span>
              <div class="user-requirement-progress">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progress}%"></div>
                <span class="progress-text ${isComplete ? 'progress-complete' : 'progress-incomplete'}">
                  ${isComplete ? '‚úì' : ''} ${progressText}
                </span>
              </div>
            </div>
          `;
        }
      });
      
      if (userRequirementsHTML) {
        userRequirements.style.display = 'block';
        userRequirementsList.innerHTML = userRequirementsHTML;
      } else {
        userRequirements.style.display = 'none';
      }
    } catch (err) {
      console.error('Error rendering user requirements:', err);
      userRequirements.style.display = 'none';
    }
  }

  async function renderRequirementsBox() {
    try {
      console.log('Rendering requirements box for labels:', currentUserLabels);
      const requirementsBox = document.getElementById('requirementsBox');
      
      // Only render user requirements if current user has labels
      if (!currentUser || !currentUserLabels.length) {
        requirementsBox.innerHTML = '<p style="text-align:center;color:#888;">No department assignments</p>';
        userRequirements.style.display = 'none';
        return;
      }
      
      // Get fresh user data
      const userRes = await fetch('/dashboard/players');
      const allPlayers = userRes.ok ? await userRes.json() : [];
      const freshUserData = allPlayers.find(p => p.roblox_id === currentUser.roblox_id);
      
      // Get shift stats
      const stats = await calculateShiftStats();
      const userStats = stats[currentUser.username.toLowerCase()] || { hosted: 0, attended: 0 };
      
      const weeklyMinutes = freshUserData?.weekly_minutes || 0;
      
      // Define requirements for each tag
      const tagRequirements = {
        'Management': { type: 'shifts', action: 'attended', required: 2, current: userStats.attended },
        'Public Relations': { type: 'shifts', action: 'attended', required: 2, current: userStats.attended },
        'Operations': { type: 'shifts', action: 'hosted', required: 2, current: userStats.hosted },
        'Human Resources': { type: 'shifts', action: 'hosted', required: 2, current: userStats.hosted },
        'Supervision': { type: 'minutes', required: 90, current: weeklyMinutes }
      };
      
      // Build requirements HTML only for user's labels
      let requirementsHTML = '';
      
      currentUserLabels.forEach(label => {
        if (tagRequirements[label]) {
          const req = tagRequirements[label];
          const progress = Math.min((req.current / req.required) * 100, 100);
          const isComplete = req.current >= req.required;
          
          let progressText = '';
          if (req.type === 'shifts') {
            progressText = `${req.current}/${req.required} shifts ${req.action}`;
          } else {
            progressText = `${req.current}/${req.required} minutes`;
          }
          
          requirementsHTML += `
            <div class="requirement-tag">
              <div>
                <div class="requirement-tag-name">${label}</div>
                <div class="requirement-tag-desc">${progressText}</div>
              </div>
              <div class="progress-bar" style="width:150px;">
                <div class="progress-fill" style="width: ${progress}%; background: ${isComplete ? '#28a745' : '#42b4ff'};"></div>
              </div>
            </div>
          `;
        }
      });
      
      // Display in requirementsBox
      if (requirementsHTML) {
        requirementsBox.innerHTML = requirementsHTML;
      } else {
        requirementsBox.innerHTML = '<p style="text-align:center;color:#888;">No requirements to display</p>';
      }
      
      // Hide the userRequirements section since we're using requirementsBox
      userRequirements.style.display = 'none';
      
    } catch (err) {
      console.error('Error rendering requirements box:', err);
      const requirementsBox = document.getElementById('requirementsBox');
      requirementsBox.innerHTML = '<p style="text-align:center;color:#888;">Error loading requirements</p>';
      userRequirements.style.display = 'none';
    }
  }

  async function calculateShiftStats() {
    try {
      console.log('Calculating shift stats...');
      const shiftRes = await fetch('/shifts');
      const shifts = shiftRes.ok ? await shiftRes.json() : [];
      
      const now = Date.now();
      const weekStart = new Date(now);
      weekStart.setHours(0, 0, 0, 0);
      weekStart.setDate(weekStart.getDate() - ((weekStart.getDay() + 6) % 7));
      
      const stats = {};
      
      for (const shift of shifts) {
        const shiftTime = shift.shift_time || shift.time;
        const timestamp = shiftTime.toString().length === 10 ? shiftTime * 1000 : shiftTime;
        
        if (timestamp < weekStart.getTime()) continue;
        
        if (shift.host && shift.host !== 'TBD') {
          const hostLower = shift.host.toLowerCase();
          if (!stats[hostLower]) stats[hostLower] = { hosted: 0, attended: 0 };
          stats[hostLower].hosted++;
        }
        
        if (shift.cohost) {
          const cohostLower = shift.cohost.toLowerCase();
          if (!stats[cohostLower]) stats[cohostLower] = { hosted: 0, attended: 0 };
          stats[cohostLower].hosted++;
        }
        
        const attendeesRes = await fetch(`/shifts/attendees?shiftId=${shift.id}`);
        if (attendeesRes.ok) {
          const attendees = await attendeesRes.json();
          attendees.forEach(a => {
            const usernameLower = a.username.toLowerCase();
            if (!stats[usernameLower]) stats[usernameLower] = { hosted: 0, attended: 0 };
            stats[usernameLower].attended++;
          });
        }
      }
      
      console.log('Shift stats calculated:', stats);
      return stats;
    } catch(err) {
      console.error('Error calculating shift stats:', err);
      return {};
    }
  }

  async function renderUpcomingBirthdays() {
    try {
      console.log('Loading upcoming birthdays...');
      const res = await fetch('/settings/birthdays');
      if (!res.ok) {
        document.getElementById('upcomingBirthdays').innerHTML = '<div class="no-data">Unable to load birthdays</div>';
        return;
      }
      
      const birthdays = await res.json();
      const today = new Date();
      
      const upcoming = birthdays.map(b => {
        const bday = new Date(b.birthday);
        const bdayThisYear = new Date(today.getFullYear(), bday.getMonth(), bday.getDate());
        
        if (bdayThisYear < today) {
          bdayThisYear.setFullYear(today.getFullYear() + 1);
        }
        
        const daysUntil = Math.floor((bdayThisYear - today) / (1000 * 60 * 60 * 24));
        
        return { ...b, daysUntil, date: bdayThisYear, isToday: daysUntil === 0 };
      })
      .filter(b => b.daysUntil <= 30)
      .sort((a, b) => a.daysUntil - b.daysUntil)
      .slice(0, 3);
      
      const birthdaysGrid = document.getElementById('upcomingBirthdays');
      
      if (!upcoming.length) {
        birthdaysGrid.innerHTML = '<div class="no-data">No birthdays in the next 30 days</div>';
        return;
      }
      
      const playersRes = await fetch('/dashboard/players');
      const allPlayers = playersRes.ok ? await playersRes.json() : [];
      
      birthdaysGrid.innerHTML = upcoming.map(b => {
        const player = allPlayers.find(p => p.roblox_id === b.roblox_id);
        const avatarUrl = player?.avatar_url || 'https://placehold.co/80x80/e0e6f0/5f6c7b?text=U';
        const dayText = b.isToday ? 'Today!' : `In ${b.daysUntil} day${b.daysUntil !== 1 ? 's' : ''}`;
        
        return `
          <div class="player-card" onclick="window.location='/dashboard/player/${b.username}'">
            <div class="avatar-wrapper">
              <img src="${avatarUrl}" onerror="this.src='https://placehold.co/80x80/e0e6f0/5f6c7b?text=U';"/>
              ${b.isToday ? '<span class="birthday-badge">üéÇ</span>' : ''}
            </div>
            <div>${b.username}</div>
            <div class="time" style="${b.isToday ? 'color:#ff4444;font-weight:700;' : ''}">${dayText}</div>
          </div>`;
      }).join('');
    } catch(err) {
      console.error('Error loading birthdays:', err);
      document.getElementById('upcomingBirthdays').innerHTML = '<div class="no-data">Failed to load birthdays</div>';
    }
  }
  
  renderUpcomingBirthdays();
  setInterval(renderUpcomingBirthdays, 300000);

  // Function to render My Account tab
  function renderMyAccount() {
    // This would be implemented if needed for home page
  }

  // Notification dropdown functionality
  const notificationIcon = document.getElementById('notificationIcon');
  const notificationBadge = document.getElementById('notificationBadge');
  const notificationDropdown = document.getElementById('notificationDropdown');

  notificationIcon.addEventListener('click', function() {
    notificationDropdown.classList.toggle('show');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    if (!notificationIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
      notificationDropdown.classList.remove('show');
    }
  });
});
</script>
</body>
</html>
